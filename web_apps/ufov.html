<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NeuroChess UFOV Extreme</title>
    <style>
        :root {
            --bg: #050505; --sq-l: #d1d1d1; --sq-d: #7a7a7a;
            --neon-green: #39ff14; --neon-red: #ff3131;
            --electric-blue: #00f2ff; --hot-pink: #ff00ff; --amber: #ffbf00;
            --sq-size: 80px; 
        }

        body {
            background: var(--bg); color: #eee; font-family: 'Segoe UI', Tahoma, sans-serif;
            display: flex; flex-direction: column; align-items: center;
            height: 100vh; margin: 0; overflow: hidden; cursor: default !important;
        }

        .dashboard {
            background: #111; width: 100%; padding: 10px 0;
            display: flex; flex-direction: column; gap: 8px; align-items: center;
            border-bottom: 1px solid #333; z-index: 100;
        }

        .dash-row { display: flex; justify-content: center; gap: 15px; align-items: center; width: 100%; }
        .stat-box { text-align: center; min-width: 70px; border-right: 1px solid #333; padding-right: 10px; }
        .stat-label { font-size: 0.6rem; color: #888; text-transform: uppercase; }
        .stat-val { font-size: 1rem; font-weight: bold; color: var(--neon-green); font-family: monospace; }

        input, select, button { background: #222; color: white; border: 1px solid #444; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; }
        #toggle-btn { background: var(--neon-green); color: black; font-weight: bold; cursor: pointer; padding: 8px 25px; border: none; }
        #toggle-btn.running { background: var(--neon-red); color: white; }

        .help-icon {
            background: #b71c1c; color: white; border-radius: 50%; width: 22px; height: 22px;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; cursor: pointer; border: none; font-size: 14px; margin-left: 5px;
        }

        #viewport { flex-grow: 1; display: flex; align-items: center; justify-content: center; width: 100%; background: black; }
        #board {
            display: grid; grid-template-columns: repeat(8, var(--sq-size)); grid-template-rows: repeat(8, var(--sq-size));
            border: 2px solid #444; position: relative; background: #000;
        }

        .square { width: var(--sq-size); height: var(--sq-size); display: flex; justify-content: center; align-items: center; position: relative; }
        .light { background: var(--sq-l); }
        .dark { background: var(--sq-d); }
        #fixation { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 30px; color: var(--neon-red); pointer-events: none; z-index: 10; opacity: 0.4; }

        .flash-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; display: none; }
        .piece-container { 
            width: 90%; height: 90%; display: flex; justify-content: center; align-items: center; z-index: 5; 
            pointer-events: none; border-radius: 50%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 80%);
        }
        .piece-svg { width: 85%; height: 85%; }
        .correct-pulse { background-color: #1b5e20 !important; }
        .fail-pulse { background-color: #b71c1c !important; }

		.modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); display: none; flex-direction: column;
            align-items: center; justify-content: center; z-index: 500;
        }

        .modal-content {
            background: #1a1a1a; padding: 30px; border-radius: 12px; width: 85%; max-width: 800px;
            max-height: 80vh; overflow-y: auto; border: 1px solid #333; position: relative;
        }

		.modal-content a:visited {
			color: var(--electric-blue);
		}

        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; color: #666; }
        #target-display {
            width: 140px; height: 140px; margin: 15px auto; 
            background: radial-gradient(circle, #eee 0%, #aaa 60%, transparent 100%); 
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
        }

        .report-card { background: #1a1a1a; padding: 25px; border-radius: 12px; width: 95%; max-width: 700px; border: 1px solid #333; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; font-family: monospace; }
        th, td { padding: 8px; border-bottom: 1px solid #333; text-align: center; }
		.summary-grid { 
			display: flex; 
			justify-content: center; /* Centers the group */
			gap: 40px;               /* Controls how close items are to each other */
			margin: 20px auto 0;    /* Centers the grid within the card */
			padding-top: 20px; 
			border-top: 1px solid #333; 
			max-width: 400px;        /* Limits the spread */
		}

		.summary-item { 
			text-align: center; 
			flex: 1;                 /* Ensures equal spacing within the max-width */
		}

		.summary-val { 
			font-size: 1.6rem; 
			color: var(--neon-green); 
			font-weight: bold; 
			display: block; 
			margin-top: 5px;
		}
    </style>
</head>
<body>

	<div id="help-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('help-modal')">&times;</span>
            <h2 style="text-align: center;">NeuroChess UFOV Extreme</h2>
            
            <h3>How to Play</h3>
            <p>This is a dual-task cognitive trainer designed to expand your <b>Useful Field of View (UFOV)</b>. You must process high-resolution information in the center while detecting flashes in your periphery.</p>
            <ul>
                <li><strong>The Target:</strong> At the start, you are assigned a Target Piece. Memorize it.</li>
                <li><strong>Match Condition:</strong> If the central piece matches your target, click the <b>Peripheral Flash</b>.</li>
                <li><strong>Lure Condition:</strong> If the central piece is <u>NOT</u> your target, click the <b>Center Square</b> where the piece is.</li>
                <li><strong>Confounders:</strong> If enabled, a second color will flash to distract you. Only react to your primary Target Color.</li>
            </ul>

            <h3>Neuroscience & UFOV</h3>
            <p>UFOV measures the spatial area from which a person can extract information in a single glance. Training this area has been clinically linked to significant "far-transfer" improvements in real-world processing speeds and a reduced risk of cognitive decline.</p>
            
            <h3>Enhancement</h3>
            <p><strong>Selective Attention:</strong> By introducing confounders, we trigger <b>Feature Integration Theory</b>, forcing the brain to bind color and location data synchronously, increasing load on the Parietal Cortex.</p>

            <h3>Research Links</h3>
            <ul>
                <li><a href="https://www.researchgate.net/publication/19924790_Age_and_visual_search_expanding_the_useful_field_of_view" target="_blank">Age and visual search: expanding the useful field of view(Ball et al.)</a></li>
                <li><a href="https://pubmed.ncbi.nlm.nih.gov/29201994/" target="_blank">Speed of processing training results in lower risk of dementia (Edwards et al.)</a></li>
                <li><a href="https://www.nature.com/articles/nature01647" target="_blank">Action video game modifies visual selective attention (Green & Bavelier)</a></li>
            </ul>
        </div>
    </div>

    <div id="announce-overlay" class="modal">
        <div class="modal-content" style="text-align: center;">
            <h1 style="color:var(--neon-green)">TARGET ACQUIRED</h1>
            <div id="target-display"></div>
            <p>Follow the <span id="target-name" style="font-weight:bold; color:white"></span>.</p>
            <button onclick="beginActualTraining()" style="margin-top:15px; padding:12px 40px; font-size:1.1rem; cursor: pointer;">ENGAGE</button>
        </div>
    </div>

    <div class="dashboard" id="controls">
        <div class="dash-row">
            <div class="stat-box"><div class="stat-label">Timer</div><div id="timer-out" class="stat-val">03:00</div></div>
            <div class="stat-box"><div class="stat-label">Correct</div><div id="correct-out" class="stat-val">0</div></div>
            <div class="stat-box"><div class="stat-label">Plays</div><div id="plays-out" class="stat-val">0</div></div>
            <div class="stat-box" style="border:none"><div class="stat-label">Speed</div><div id="speed-out" class="stat-val">--</div></div>
            <button id="toggle-btn" onclick="toggleGame()">START TRAINING</button>
            <button class="help-icon" onclick="openModal('help-modal')">?</button>
        </div>
        <div class="dash-row" style="border-top: 1px solid #222; padding-top: 5px;">
            <div class="config-group"><label class="stat-label">Min ms:</label><input type="number" id="min-ms-input" value="30" min="10" step="10" style="width:45px;"></div>
            <div class="config-group"><label class="stat-label">Start (s):</label><input type="number" id="start-time-input" value="1" step="0.1" style="width:45px;"></div>
            <div class="config-group">
                <select id="game-time-select" onchange="updateTimerPreview()">
                    <option value="1">1m</option><option value="3" selected>3m</option><option value="5">5m</option><option value="10">10m</option><option value="20">20m</option><option value="30">30m</option><option value="0">âˆž</option>
                </select>
            </div>
            <div class="config-group">
                <select id="size-toggle" onchange="updateScale()"><option value="1">100%</option><option value="0.75" selected>75%</option><option value="0.5">50%</option><option value="0.25">25%</option></select>
            </div>
            <div class="config-group" style="border-left: 1px solid #333; padding-left:10px;">
                <label class="stat-label">Target:</label>
                <select id="target-color-select" onchange="validateColors()">
                    <option value="var(--amber)">Amber</option><option value="var(--electric-blue)">Blue</option><option value="var(--hot-pink)">Pink</option>
                </select>
            </div>
            <div class="config-group">
                <input type="checkbox" id="confounder-check"><label class="stat-label" for="confounder-check">Confounder:</label>
                <select id="confounder-color-select" onchange="validateColors()">
                    <option value="var(--electric-blue)" selected>Blue</option><option value="var(--hot-pink)" >Pink</option><option value="var(--amber)">Amber</option>
                </select>
            </div>
        </div>
    </div>

    <div id="viewport"><div id="board"><div id="fixation">+</div></div></div>

    <div id="report-overlay" class="modal">
        <div class="report-card">
            <h2 id="report-title" style="margin:0; color:var(--neon-green); text-align: center;">SESSION PERFORMANCE</h2>
            <table id="report-table">
				<thead>
					<tr>
						<th>Speed</th>
						<th>Correct</th> <th>Plays</th>   <th>Accuracy</th>
					</tr>
				</thead>
				<tbody id="report-body"></tbody>
			</table>
			<div class="summary-grid">
				<div class="summary-item">
					<div class="stat-label">CORRECT</div>
					<div id="total-correct-sum" class="summary-val">0</div>
				</div>
				<div class="summary-item">
					<div class="stat-label">PLAYS</div>
					<div id="total-plays-sum" class="summary-val">0</div>
				</div>
				<div class="summary-item">
					<div class="stat-label">ACCURACY</div>
					<div id="overall-acc-sum" class="summary-val">0%</div>
				</div>
			</div>
            <button onclick="closeReport()" style="width:100%; background:var(--neon-green); color:black; font-weight:bold; padding:12px; cursor: pointer; border: none; border-radius: 4px; margin-top: 20px;">RESTART</button>
        </div>
    </div>

<script>
    const svgs = {
        bishop: `<svg viewBox="0 0 45 45" class="piece-svg"><g fill="none" fill-rule="evenodd" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"><g fill="#000" stroke-linecap="butt"><path d="M9 36c3.4-1 10.1.4 13.5-2 3.4 2.4 10.1 1 13.5 2 0 0 1.6.5 3 2-.7 1-1.6 1-3 .5-3.4-1-10.1.5-13.5-1-3.4 1.5-10.1 0-13.5 1-1.4.5-2.3.5-3-.5 1.4-2 3-2 3-2z"/><path d="M15 32c2.5 2.5 12.5 2.5 15 0 .5-1.5 0-2 0-2 0-2.5-2.5-4-2.5-4 5.5-1.5 6-11.5-5-15.5-11 4-10.5 14-5 15.5 0 0-2.5 1.5-2.5 4 0 0-.5.5 0 2z"/><path d="M25 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 1 1 5 0z"/></g><path stroke="#ececec" stroke-linejoin="miter" d="M17.5 26h10M15 30h15m-7.5-14.5v5M20 18h5"/></g></svg>`,
        king: `<svg viewBox="0 0 45 45" class="piece-svg"><g fill="none" fill-rule="evenodd" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"><path stroke-linejoin="miter" d="M22.5 11.6V6"/><path fill="#000" stroke-linecap="butt" stroke-linejoin="miter" d="M22.5 25s4.5-7.5 3-10.5c0 0-1-2.5-3-2.5s-3 2.5-3 2.5c-1.5 3 3 10.5 3 10.5"/><path fill="#000" d="M11.5 37a22.3 22.3 0 0 0 21 0v-7s9-4.5 6-10.5c-4-6.5-13.5-3.5-16 4V27v-3.5c-3.5-7.5-13-10.5-16-4-3 6 5 10 5 10V37z"/><path stroke-linejoin="miter" d="M20 8h5"/><path stroke="#ececec" d="M32 29.5s8.5-4 6-9.7C34.1 14 25 18 22.5 24.6v2.1-2.1C20 18 9.9 14 7 19.9c-2.5 5.6 4.8 9 4.8 9"/><path stroke="#ececec" d="M11.5 30c5.5-3 15.5-3 21 0m-21 3.5c5.5-3 15.5-3 21 0m-21 3.5c5.5-3 15.5-3 21 0"/></g></svg>`,
        knight: `<svg viewBox="0 0 45 45" class="piece-svg"><g fill="none" fill-rule="evenodd" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"><path fill="#000" d="M22 10c10.5 1 16.5 8 16 29H15c0-9 10-6.5 8-21"/><path fill="#000" d="M24 18c.38 2.91-5.55 7.37-8 9-3 2-2.82 4.34-5 4-1.04-.94 1.41-3.04 0-3-1 0 .19 1.23-1 2-1 0-4 1-4-4 0-2 6-12 6-12s1.89-1.9 2-3.5c-.73-1-.5-2-.5-3 1-1 3 2.5 3 2.5h2s.78-2 2.5-3c1 0 1 3 1 3"/><path fill="#ececec" stroke="#ececec" d="M9.5 25.5a.5.5 0 1 1-1 0 .5.5 0 1 1 1 0zm5.43-9.75a.5 1.5 30 1 1-.86-.5.5 1.5 30 1 1 .86.5z"/><path fill="#ececec" stroke="none" d="m24.55 10.4-.45 1.45.5.15c3.15 1 5.65 2.49 7.9 6.75S35.75 29.06 35.25 39l-.05.5h2.25l.05-.5c.5-10.06-.88-16.85-3.25-21.34-2.37-4.49-5.79-6.64-9.19-7.16l-.51-.1z"/></g></svg>`,
        pawn: `<svg viewBox="0 0 45 45" class="piece-svg"><path stroke="#000" stroke-linecap="round" stroke-width="1.5" d="M22.5 9a4 4 0 0 0-3.22 6.38 6.48 6.48 0 0 0-.87 10.65c-3 1.06-7.41 5.55-7.41 13.47h23c0-7.92-4.41-12.41-7.41-13.47a6.46 6.46 0 0 0-.87-10.65A4.01 4.01 0 0 0 22.5 9z"/></svg>`,
        queen: `<svg viewBox="0 0 45 45" class="piece-svg"><g fill-rule="evenodd" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"><g stroke="none"><circle cx="6" cy="12" r="2.75"/><circle cx="14" cy="9" r="2.75"/><circle cx="22.5" cy="8" r="2.75"/><circle cx="31" cy="9" r="2.75"/><circle cx="39" cy="12" r="2.75"/></g><path stroke-linecap="butt" d="M9 26c8.5-1.5 21-1.5 27 0l2.5-12.5L31 25l-.3-14.1-5.2 13.6-3-14.5-3 14.5-5.2-13.6L14 25 6.5 13.5 9 26z"/><path stroke-linecap="butt" d="M9 26c0 2 1.5 2 2.5 4 1 1.5 1 1 .5 3.5-1.5 1-1.5 2.5-1.5 2.5-1.5 1.5.5 2.5.5 2.5 6.5 1 16.5 1 23 0 0 0 1.5-1 0-2.5 0 0 .5-1.5-1-2.5-.5-2.5-.5-2 .5-3.5 1-2 2.5-2 2.5-4-8.5-1.5-18.5-1.5-27 0z"/><path fill="none" stroke-linecap="butt" d="M11 38.5a35 35 1 0 0 23 0"/><path fill="none" stroke="#ececec" d="M11 29a35 35 1 0 1 23 0m-21.5 2.5h20m-21 3a35 35 1 0 0 22 0m-23 3a35 35 1 0 0 24 0"/></g></svg>`,
        rook: `<svg viewBox="0 0 45 45"><g fill-rule="evenodd" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"><path stroke-linecap="butt" d="M9 39h27v-3H9v3zm3.5-7 1.5-2.5h17l1.5 2.5h-20zm-.5 4v-4h21v4H12z"/><path stroke-linecap="butt" stroke-linejoin="miter" d="M14 29.5v-13h17v13H14z"/><path stroke-linecap="butt" d="M14 16.5 11 14h23l-3 2.5H14zM11 14V9h4v2h5V9h5v2h5V9h4v5H11z"/><path fill="none" stroke="#ececec" stroke-linejoin="miter" stroke-width="1" d="M12 35.5h21m-20-4h19m-18-2h17m-17-13h17M11 14h23"/></g></svg>`
    };

    const BOARD_EDGES = Array.from({length: 64}, (_,i)=>i).filter(i=>{ const r=Math.floor(i/8), c=i%8; return r===0||r===7||c===0||c===7; });

    let isRunning = false, speed = 1000, ghostIdx = -1, centralIdx = -1, awaitingInput = false, sessionTimer = null, trialTimeout = null, cutoffRAF = null;
    let targetPieceKey = '', sessionHasConfounder = false, timeLeft = 0, totalPlays = 0, totalCorrect = 0, frameMs = 16.67, stats = {}, minSpeedFloor = 20;
    let flashEls = [], pieceContainers = [];

    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    function validateColors() {
        const t = document.getElementById('target-color-select'), c = document.getElementById('confounder-color-select');
        if(t.value === c.value) c.selectedIndex = (c.selectedIndex + 1) % c.options.length;
    }

    function updateTimerPreview() {
        if (isRunning) return;
        const mode = parseInt(document.getElementById('game-time-select').value);
        const display = document.getElementById('timer-out');
        display.innerText = mode === 0 ? "00:00" : `${mode.toString().padStart(2, '0')}:00`;
    }

    function updateScale() {
        const z = parseFloat(document.getElementById('size-toggle').value);
        const dashH = document.getElementById('controls').offsetHeight;
        const size = (Math.min(window.innerWidth - 40, window.innerHeight - dashH - 40) / 8) * z;
        document.documentElement.style.setProperty('--sq-size', `${size}px`);
    }

    function initBoard() {
        const b = document.getElementById('board'); b.innerHTML = '<div id="fixation">+</div>';
        flashEls = []; pieceContainers = [];
        for (let i = 0; i < 64; i++) {
            const s = document.createElement('div');
            s.className = `square ${(Math.floor(i/8)+i%8)%2===0 ? 'light':'dark'}`;
            s.id = `sq-${i}`; s.innerHTML = `<div class="flash-bg" id="f-${i}"></div><div id="p-${i}" class="piece-container"></div>`;
            s.onclick = () => handleInput(i); b.appendChild(s);
            flashEls.push(document.getElementById(`f-${i}`));
            pieceContainers.push(document.getElementById(`p-${i}`));
        }
    }

    function toggleGame() {
        if(isRunning) { stopTraining(); return; }
        const keys = Object.keys(svgs);
        targetPieceKey = keys[Math.floor(Math.random() * keys.length)];
        document.getElementById('target-display').innerHTML = svgs[targetPieceKey];
        document.getElementById('target-name').innerText = targetPieceKey.toUpperCase();
        openModal('announce-overlay');
    }

    function beginActualTraining() {
        closeModal('announce-overlay'); isRunning = true;
        document.getElementById('toggle-btn').innerText = "STOP";
        document.getElementById('toggle-btn').classList.add('running');
        stats = {}; totalPlays = 0; totalCorrect = 0;
        sessionHasConfounder = document.getElementById('confounder-check').checked;
        speed = parseFloat(document.getElementById('start-time-input').value) * 1000;
        minSpeedFloor = parseInt(document.getElementById('min-ms-input').value);
        const mode = parseInt(document.getElementById('game-time-select').value);
        timeLeft = mode === 0 ? 0 : mode * 60;
        clearInterval(sessionTimer);
        sessionTimer = setInterval(() => {
            mode === 0 ? timeLeft++ : timeLeft--;
            if(mode !== 0 && timeLeft <= 0) stopTraining();
            const min = Math.floor(Math.abs(timeLeft)/60), sec = Math.abs(timeLeft)%60;
            document.getElementById('timer-out').innerText = `${min.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
        }, 1000);
        updateUI(); runTrial();
    }

    function stopTraining() {
        isRunning = false; clearInterval(sessionTimer); clearTimeout(trialTimeout); cancelAnimationFrame(cutoffRAF);
        document.getElementById('toggle-btn').innerText = "START TRAINING";
        document.getElementById('toggle-btn').classList.remove('running');
        showReport();
    }

    function runTrial() {
        if(!isRunning) return;
        awaitingInput = false; resetBoardStyles();
        ghostIdx = BOARD_EDGES[Math.floor(Math.random()*BOARD_EDGES.length)];
        centralIdx = [27, 28, 35, 36][Math.floor(Math.random()*4)];
        currentTrialIsMatch = (totalPlays < 2) ? true : (Math.random() > 0.33);
        const lurePool = Object.keys(svgs).filter(k => k !== targetPieceKey);
        const trialPieceKey = currentTrialIsMatch ? targetPieceKey : lurePool[Math.floor(Math.random()*lurePool.length)];
        
        const tColor = document.getElementById('target-color-select').value;
        const cColor = document.getElementById('confounder-color-select').value;
        document.getElementById('speed-out').innerText = Math.round(speed) + "ms";

        trialTimeout = setTimeout(() => {
            if(!isRunning) return;
            requestAnimationFrame(() => {
                if(!isRunning) return;
                const tf = flashEls[ghostIdx]; tf.style.backgroundColor = tColor; tf.style.display = 'block';
                if(sessionHasConfounder) {
                    const cfPool = BOARD_EDGES.filter(i=>i!==ghostIdx);
                    const cf = flashEls[cfPool[Math.floor(Math.random()*cfPool.length)]];
                    cf.style.backgroundColor = cColor; cf.style.display = 'block';
                }
                pieceContainers[centralIdx].innerHTML = svgs[trialPieceKey];
                const op = speed < frameMs ? speed / frameMs : 1.0; tf.style.opacity = op;
                const start = performance.now();
                function cutoff(n) {
                    if(!isRunning) return;
                    if(n-start >= Math.max(speed, frameMs)) {
                        flashEls.forEach(f => { f.style.display = 'none'; f.style.opacity = 1; });
                        pieceContainers.forEach(p => p.innerHTML = '');
                        awaitingInput = true;
                    } else cutoffRAF = requestAnimationFrame(cutoff);
                }
                cutoffRAF = requestAnimationFrame(cutoff);
            });
        }, 600);
    }

    function handleInput(idx) {
        if(!isRunning || !awaitingInput) return;
        awaitingInput = false;
        const skey = Math.round(speed); if(!stats[skey]) stats[skey] = {c:0, t:0};
        stats[skey].t++; totalPlays++;

        const isCorrect = (currentTrialIsMatch && idx === ghostIdx) || (!currentTrialIsMatch && idx === centralIdx);
        if(isCorrect) {
            stats[skey].c++; totalCorrect++;
            document.getElementById(`sq-${idx}`).classList.add('correct-pulse');
            speed = Math.max(minSpeedFloor, (speed > 100 ? speed - 100 : (speed > 10 ? speed - 10 : speed - 1)));
        } else {
            document.getElementById(`sq-${idx}`).classList.add('fail-pulse');
            document.getElementById(`sq-${currentTrialIsMatch ? ghostIdx : centralIdx}`).classList.add('correct-pulse');
            speed = Math.max(minSpeedFloor, (speed < 30 ? 30 : speed + (speed >= 100 ? 200 : 20)));
        }
        updateUI(); setTimeout(runTrial, 500);
    }

    function updateUI() { document.getElementById('correct-out').innerText = totalCorrect; document.getElementById('plays-out').innerText = totalPlays; }

	function showReport() {
		const body = document.getElementById('report-body'); 
		body.innerHTML = '';
		const sorted = Object.keys(stats).map(Number).sort((a,b)=>b-a);
		
		sorted.forEach(s => {
			const r = body.insertRow();
			const d = stats[s];
			
			r.insertCell(0).innerText = s + "ms";                   // Speed
			r.insertCell(1).innerText = d.c;                        // Correct (Swapped)
			r.insertCell(2).innerText = d.t;                        // Plays (Swapped)
			r.insertCell(3).innerText = ((d.c/d.t)*100).toFixed(0) + "%"; // Accuracy
		});

		const acc = (totalPlays > 0 ? (totalCorrect/totalPlays*100).toFixed(1) : 0);
		document.getElementById('total-plays-sum').innerText = totalPlays;
		document.getElementById('total-correct-sum').innerText = totalCorrect;
		document.getElementById('overall-acc-sum').innerText = acc + "%";
		
		// Ensure summary text matches your desired reading flow
		// document.getElementById('summary-text').innerText = `Final Result: ${totalCorrect} out of ${totalPlays}`;
		
		openModal('report-overlay');
	}

    function closeReport() { closeModal('report-overlay'); updateUI(); updateTimerPreview(); }
    function resetBoardStyles() { document.querySelectorAll('.square').forEach(s=>s.classList.remove('correct-pulse','fail-pulse')); }

    async function detectHz() {
        return new Promise(resolve => {
            let frames = [];
            function check(t) {
                frames.push(t); if (frames.length < 30) requestAnimationFrame(check);
                else { frameMs = (frames[frames.length-1]-frames[0])/(frames.length-1); resolve(); }
            }
            requestAnimationFrame(check);
        });
    }

    detectHz().then(() => { initBoard(); updateScale(); updateTimerPreview(); window.onresize = updateScale; });
</script>
</body>
</html>